services:
  # We use PostgreSQL (https://www.postgresql.org/) for storing metadata for bufstream.
  postgres:
    # Our minimum supported version for PostgreSQL is 14.
    image: postgres:14
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=examplebufstreamdb
    network_mode: host
    healthcheck:
      test: ["CMD", "pg_isready", "-d", "examplebufstreamdb"]

  minio:
    image: minio/minio:RELEASE.2025-05-24T17-08-30Z
    network_mode: host
    healthcheck:
      test: ["CMD", "curl", "--silent", "--fail", "--output", "/dev/null", "http://localhost:9000/minio/health/live"]
    command: ["server", "/data", "--console-address", ":9001"]

  # We use Minio Client (https://min.io/docs/minio/linux/reference/minio-mc.html)
  # to bootstrap a MinIO Bucket as MinIO doesn't come prepopulated with one, and
  # Bufstream doesn't create one itself.
  mc:
    image: minio/mc:RELEASE.2025-05-21T01-59-54Z
    network_mode: host
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      until (/usr/bin/mc alias set minio http://localhost:9000 minioadmin minioadmin) do echo '...waiting...' && sleep 1; done;
      /usr/bin/mc mb minio/bufstream;
      /usr/bin/mc anonymous set public minio/bufstream;
      tail -f /dev/null
      "

  bufstream:
    image: bufbuild/bufstream:0.3.27
    hostname: bufstream
    depends_on:
      minio:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - BUFSTREAM_KAFKA_HOST=localhost
      - BUFSTREAM_KAFKA_PUBLIC_HOST=localhost
    network_mode: host
    # Edit bufstream.yaml within this repository to change configuration.
    volumes:
      - ./bufstream.yaml:/bufstream.yaml
    healthcheck:
      test: ["CMD", "/usr/local/bin/bufstream", "admin", "status", "--exit-code", "--url", "http://127.0.0.1:9089"]
    command: ["serve", "--config", "/bufstream.yaml"]
